<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Solidity Compiler (Works!)</title>
</head>
<body>
  <h2>Browser Solidity Compiler (With Fix)</h2>
  <textarea id="source" style="width:100%; height:200px;">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract HelloWorld {
    string public greeting = "Hello, world!"
}
  </textarea>
  <br>
  <button onclick="safeCompile()">Compile</button>

  <script>
    let compiler;
    let compilerReady;

    // âœ… PREPARE the Module before loading script
    compilerReady = new Promise((resolve, reject) => {
      window.Module = {
        onRuntimeInitialized: () => {
          alert("ğŸ§  Compiler WebAssembly initialized!");
          compiler = setupSolc(Module);
          resolve();
        }
      };

      // âœ… NOW load soljson after Module is ready
      const script = document.createElement("script");
      script.src = "https://binaries.soliditylang.org/bin/soljson-v0.8.21+commit.d9974bed.js";
      script.onload = () => alert("ğŸ“¦ soljson script loaded");
      script.onerror = () => reject("âŒ Failed to load compiler script.");
      document.body.appendChild(script);
    });

    function setupSolc(Module) {
      alert("âœ… setupSolc() called");
      return {
        compile: (input) => {
          alert("âœ… compiler.compile() called");
          const inputStr = JSON.stringify(input);
          alert("ğŸ“¦ JSON input:\n" + inputStr);
          const outputStr = Module.ccall(
            'solidity_compileStandard',
            'string',
            ['string'],
            [inputStr]
          );
          alert("âœ… Compilation finished");
          return JSON.parse(outputStr);
        }
      };
    }

    function safeCompile() {
      try {
        compile();
      } catch (err) {
        alert("ğŸ”¥ GLOBAL ERROR:\n" + err.message);
      }
    }

    async function compile() {
      alert("ğŸ”„ Compile button clicked");

      const source = document.getElementById("source").value;
      alert("ğŸ“„ Source code loaded");

      const input = {
        language: 'Solidity',
        sources: {
          'MyContract.sol': { content: source }
        },
        settings: {
          outputSelection: {
            '*': {
              '*': ['abi', 'evm.bytecode']
            }
          }
        }
      };
      alert("ğŸ“¦ Compiler input constructed");

      alert("â³ Waiting for compiler to be ready...");
      await compilerReady;

      let output;
      try {
        output = compiler.compile(input);
      } catch (e) {
        alert("âŒ Error during compile():\n" + e.message);
        return;
      }

      alert("ğŸ“¤ Compiler output received");

      if (output.errors) {
        let errors = "", warnings = "";
        for (const e of output.errors) {
          if (e.severity === "error") errors += e.formattedMessage + "\n\n";
          else warnings += e.formattedMessage + "\n\n";
        }
        if (errors) alert("âŒ ERRORS:\n\n" + errors);
        if (warnings) alert("âš ï¸ WARNINGS:\n\n" + warnings);
      } else {
        alert("âœ… No compilation errors or warnings");
      }

      try {
        const contractName = Object.keys(output.contracts["MyContract.sol"])[0];
        alert("ğŸ“Œ Contract compiled: " + contractName);
        const contract = output.contracts["MyContract.sol"][contractName];
        alert("âœ… ABI:\n\n" + JSON.stringify(contract.abi, null, 2));
        alert("ğŸ”¢ Bytecode:\n\n" + contract.evm.bytecode.object);
      } catch (e) {
        alert("â›” ABI or Bytecode error:\n" + e.message);
      }
    }
  </script>
</body>
</html>
